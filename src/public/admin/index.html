<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ADMIN CMS - GI</title>
    <link href="/admin/config.yml" type="text/yaml" rel="cms-config-url">
</head>
<body>
    <script src="https://unpkg.com/decap-cms@3.9.0/dist/decap-cms.js"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
        const getYoutubeId = (url) => {
            if (!url) return null; // N·∫øu kh√¥ng c√≥ url => tr·∫£ v·ªÅ null
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        };
        const getSpotifyPath = (url) => {
            if (!url) return null;
            const regExp = /(track|album|playlist|episode|show)\/([a-zA-Z0-9]+)/;
            const match = url.match(regExp);
            return match ? match[0] : null;
        };
        
        CMS.registerEditorComponent({
            id: "youtube",
            label: "YouTube",
            fields: [{
                name: 'url',
                label: 'Youtube URL',
                widget: 'string',
                hint: 'D√°n ƒë∆∞·ªùng d·∫´n video v√†o ƒë√¢y.'
            }],
            pattern: /^<iframe.+src="https:\/\/www\.youtube\.com\/embed\/([^"]+)".+<\/iframe>$/,
            fromBlock: function(match) {
                return {
                    url: 'https://www.youtube.com/watch?v=' + match[1]
                };
            },
            toBlock: function(obj) {
                const id = getYoutubeId(obj.url);
                return '<iframe width="560" height="315" src="https://www.youtube.com/embed/' + id + '" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>';
            },
            toPreview: function(obj) {
                const id = getYoutubeId(obj.url);
                if (!id) return '<div style="color: #888; background: #eee; padding: 10px; border-radius: 5px; text-align: center; border: 1px dashed #ccc;">üîó ƒêang ch·ªù d√°n ƒë∆∞·ªùng d·∫´n Youtube...</div>';
                return '<iframe width="560" height="315" src="https://www.youtube.com/embed/' + id + '" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>';
            }
        });

        
        CMS.registerEditorComponent({
            id: "spotify",
            label: "Spotify",
            fields: [{
                name: 'url',
                label: 'Spotify URL',
                widget: 'string',
                hint: 'D√°n ƒë∆∞·ªùng d·∫´n b√†i h√°t, album ho·∫∑c podcast t·ª´ Spotify (V√≠ d·ª•: https://open.spotify.com/track/xyz...)'
            }],

            // Regex n√†y d√πng ƒë·ªÉ nh·∫≠n di·ªán block khi b·∫°n m·ªü l·∫°i b√†i vi·∫øt c≈© ƒë·ªÉ ch·ªânh s·ª≠a
            // N√≥ t√¨m th·∫ª iframe c√≥ src ch·ª©a open.spotify.com/embed/...
            pattern: /^<iframe.+src="https:\/\/open\.spotify\.com\/embed\/([^"]+)".+<\/iframe>$/,

            // Chuy·ªÉn t·ª´ HTML (ƒë√£ l∆∞u) th√†nh d·ªØ li·ªáu cho khung nh·∫≠p li·ªáu (khi s·ª≠a b√†i)
            fromBlock: function(match) {
                return {
                    url: 'https://open.spotify.com/' + match[1]
                };
            },

            // Chuy·ªÉn t·ª´ d·ªØ li·ªáu nh·∫≠p li·ªáu th√†nh HTML (ƒë·ªÉ l∆∞u v√†o file)
            toBlock: function(obj) {
                const path = getSpotifyPath(obj.url);
                if (!path) return null;
                
                // Tr·∫£ v·ªÅ iframe chu·∫©n c·ªßa Spotify
                return '<iframe style="border-radius:12px" src="https://open.spotify.com/embed/' + path + '" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>';
            },

            // Hi·ªÉn th·ªã b·∫£n xem tr∆∞·ªõc trong CMS (bao g·ªìm c·∫£ fix l·ªói m√†n h√¨nh tr·∫Øng)
            toPreview: function(obj) {
                // Ki·ªÉm tra an to√†n: n·∫øu kh√¥ng c√≥ url ho·∫∑c url r·ªóng th√¨ hi·ªán th√¥ng b√°o ch·ªù
                if (!obj || !obj.url || (typeof obj.url === 'string' && obj.url.trim() === "")) {
                    return '<div style="color: #888; background: #eee; padding: 10px; border-radius: 5px; text-align: center; border: 1px dashed #ccc;">üîó ƒêang ch·ªù d√°n link Spotify...</div>';
                }

                const path = getSpotifyPath(obj.url);
                
                // N·∫øu d√°n link nh∆∞ng kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng Spotify
                if (!path) {
                    return '<div style="color: #d9534f; background: #f9f2f4; padding: 10px; border-radius: 5px; text-align: center; border: 1px dashed #d9534f;">‚ùå Link Spotify kh√¥ng h·ª£p l·ªá ho·∫∑c ch∆∞a ƒë∆∞·ª£c h·ªó tr·ª£.</div>';
                }

                return '<iframe style="border-radius:12px" src="https://open.spotify.com/embed/' + path + '" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>';
            }
        });

        CMS.registerEventListener({
            name: 'preSave',
            handler: ({ entry }) => {
                const data = entry.get('data');
                if (data.has('body')) {
                    let body = data.get('body');
                    let originalBody = body;
                    if (body) {
                        body = body.replace(/\*\s+([\"‚Äú‚Äù])/g, '*$1');
                        body = body.replace(/([\"‚Äú‚Äù])\s+\*/g, '$1*');
                        body = body.replace(/([‚Äú"'])\*/g, '*$1');
                        body = body.replace(/\*([‚Äù"'])/g, '$1*');
                        if (body !== originalBody) {
                            return data.set('body', body);
                        }
                    }
                }
                return data;
            },
        });
    </script>
</body>
</html>
