<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <link href="/admin/config.yml" type="text/yaml" rel="cms-config-url">
</head>
<body>
    <script src="https://unpkg.com/decap-cms@3.9.0/dist/decap-cms.js"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
    const getYoutubeId = (url) => {
        if (!url) return '';
        // Regex này chấp nhận các dạng: youtube.com/watch?v=ID, youtu.be/ID, embed/ID
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        // Nếu tìm thấy ID 11 ký tự thì trả về ID, nếu không thì trả về nguyên gốc (đề phòng người dùng nhập ID trực tiếp)
        return (match && match[2].length === 11) ? match[2] : url;
    };

    // --- 2. Đăng ký thành phần Youtube ---
    CMS.registerEditorComponent({
        id: "youtube",
        label: "YouTube",
        fields: [{
            name: 'url',
            label: 'Youtube URL',
            widget: 'string',
            hint: 'Dán đường dẫn video vào đây (Ví dụ: https://www.youtube.com/watch?v=dQw4w9WgXcQ)'
        }],
        // Nhận diện thẻ iframe trong file markdown đã lưu
        pattern: /^<iframe.+src="https:\/\/www\.youtube\.com\/embed\/([^"]+)".+<\/iframe>$/,
        
        // Khi tải bài viết lên CMS: Lấy ID từ iframe và hiển thị lại dưới dạng link đầy đủ cho dễ nhìn
        fromBlock: function(match) {
            return {
                url: 'https://www.youtube.com/watch?v=' + match[1]
            };
        },
        // Khi lưu bài viết: Lấy URL người dùng nhập -> Tách ID -> Tạo thẻ iframe
        toBlock: function(obj) {
            const id = getYoutubeId(obj.url);
            return '<iframe width="560" height="315" src="https://www.youtube.com/embed/' + id + '" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>';
        },
        // Hiển thị preview trong lúc soạn thảo
        toPreview: function(obj) {
            const id = getYoutubeId(obj.url);
            return '<iframe width="560" height="315" src="https://www.youtube.com/embed/' + id + '" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';
        }
    });

    // --- 3. Sự kiện xử lý văn bản (Code cũ của bạn giữ nguyên) ---
    CMS.registerEventListener({
        name: 'preSave',
        handler: ({ entry }) => {
            const data = entry.get('data');
            if (data.has('body')) {
                let body = data.get('body');
                let originalBody = body;
                if (body) {
                    body = body.replace(/\*\s+([\"“”])/g, '*$1');
                    body = body.replace(/([\"“”])\s+\*/g, '$1*');
                    body = body.replace(/([“"'])\*/g, '*$1');
                    body = body.replace(/\*([”"'])/g, '$1*');
                    if (body !== originalBody) {
                        return data.set('body', body);
                    }
                }
            }
            return data;
        },
    });
</script>
</body>
</html>